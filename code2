import os
import time
from twelvelabs import TwelveLabs
import google.generativeai as genai


# ==========================================
# [!] CONFIGURATION: THE "AGENCY" KEYS
# ==========================================
# Get your keys from: https://playground.twelvelabs.io/ and https://aistudio.google.com/
TL_API_KEY = tlk_17MDEKC3SERJ1F2HJ6X143E88C2T
GEMINI_API_KEY = gen-lang-client-0615299254


# Initialize The Agents
client = TwelveLabs(api_key=TL_API_KEY)
genai.configure(api_key=GEMINI_API_KEY)


def print_noir(text):
   """Prints text in a 'Terminal/Noir' style."""
   print(f"\n> [SYSTEM]: {text}")


def get_visual_evidence(video_path):
   """
   Uses TwelveLabs Pegasus model to 'watch' the video
   and describe strictly what is visible.
   """
   print_noir(f"Processing Evidence: {video_path}...")


   # 1. Create a specialized index for Visual Analysis
   # We use Pegasus 1.2 for its high-fidelity video understanding
   index = client.index.create(
       name=f"CaseFile_{int(time.time())}",
       models=[
           {
               "name": "pegasus1.2",
               "options": ["visual", "audio"]
           }
       ]
   )
   print_noir(f"Index Created. Case ID: {index.id}")


   # 2. Upload the video evidence
   print_noir("Uploading footage to secure server...")
   task = client.task.create(index_id=index.id, file=video_path)
  
   # Wait for processing (The "Stakeout")
   print_noir("Analyzing video frames... (this may take a moment)")
   task.wait_for_done(sleep_interval=5)
  
   if task.status != "ready":
       raise Exception(f"Video processing failed with status: {task.status}")


   # 3. Interrogate the video (The TwelveLabs "Prompt")
   # We specifically ask for VISUAL details to cross-reference against audio/text lies.
   prompt = "Describe in extreme detail the visual setting, lighting, actions, and objects visible in this video. Do not interpret, just list the visual facts."
  
   print_noir("Extracting visual facts...")
   res = client.analyze(
       video_id=task.video_id,
       prompt=prompt
   )
  
   return res.data


def investigate_contradiction(visual_facts, suspicious_claim):
   """
   Uses Gemini Pro to act as the Detective.
   It compares the 'Visual Facts' (Truth) vs 'Suspicious Claim' (Lie).
   """
   print_noir("Contacting the Detective (Gemini)...")
  
   model = genai.GenerativeModel('gemini-1.5-pro-latest')
  
   # The Noir Persona Prompt
   detective_prompt = f"""
   You are a cynical, hard-boiled detective AI in a noir city.
   Your job is to debunk misinformation.
  
   EVIDENCE A (What the video actually shows):
   "{visual_facts}"
  
   EVIDENCE B (The suspicious social media caption):
   "{suspicious_claim}"
  
   TASK:
   Compare Evidence A and Evidence B. Does the video visually support the claim?
   Look for specific contradictions (e.g., Claim says 'Riot', Video shows 'Empty Street').
  
   OUTPUT FORMAT:
   VERDICT: [TRUE / MISLEADING / FABRICATED]
   CONFIDENCE: [0-100%]
   DETECTIVE'S NOTES: [A gritty, 2-sentence explanation of the discrepancy].
   """
  
   response = model.generate_content(detective_prompt)
   return response.text


# ==========================================
# [!] MAIN EXECUTION
# ==========================================
if __name__ == "__main__":
   # 1. Setup the "Crime Scene"
   # Replace this with a path to a real video file on your computer
   video_file = "evidence_footage.mp4"
  
   # 2. The "Lie" we are testing
   # Example: A peaceful video of a park, but the caption claims it's a war zone.
   suspicious_caption = "BREAKING: Massive riots reported in the downtown district! Smoke everywhere!"


   try:
       # Step 1: Get the truth from TwelveLabs
       visual_truth = get_visual_evidence(video_file)
       print(f"\n[Visual Log]: {visual_truth}\n")


       # Step 2: Compare with the lie using Gemini
       final_verdict = investigate_contradiction(visual_truth, suspicious_caption)
      
       # Step 3: The Reveal
       print("\n" + "="*40)
       print("     NOIR-VERIFY CASE REPORT     ")
       print("="*40)
       print(final_verdict)
       print("="*40)


   except Exception as e:
       print(f"\n[!] ERROR: Investigation compromised. Details: {e}")




